## Описание протокола
### Введение
Способы взаимодействия узлов и сервера описывает протокол. Каждое сообщение передается в формате JSON следующего формата:

```javascript
{
	"header" : "<заголовок>",

	// Данные сообщения... //
}
```

Заголовок определяет цель обращения узла к серверу, или наоборот. За обработку сообщений протокола отвечают два файла: **include/master_protocol.js** и **include/worker_protocol.js**, в которых хранятся обработчики. Рассмотрим пример запроса узла на присоединение к серверу:

```javascript
{
	"header" : "join",

	"secret" : "8b04b6229e11c290efd5cd8190aa9261",
	"async"  : false,
	"speed"  : 98000
}
```

В данном примере кластер защищен паролем, поэтому при подключении сервер высылает узлу случайно сгенерированное число - *соль*. Узел должен выполнить хэширование полученной соли и пароля, введенного пользователем и передать полученный хэш в запросе на присоединение. Также передается тип узла: *синхронный* или *асинхронный* и скорость, полученная в результате теста производительности. Ответ сервера может быть таким:

```javascript
{
	"header" : "connect",

	"status" : "joined"
}
```

Либо таким, в случае неверного пароля:

```javascript
{
	"header" : "connect",

	"status" : "rejected",
	"reason" : "bad-secret"
}
```

Подробнее об этапах подключения и взаимодействии узлов с сервером можно прочитать в файле **basics.md**.

### Формат описания протокола

#####**ЗАГОЛОВОК** - значение поля header

###### Сервер - сообщение от сервера

<table width="100%">
	<tr>
		<th>Поле</th>
		<th>Тип</th>
		<th>Описание</th>
	</tr>

	<tr>
		<td>Название</td>
		<td>Тип поля</td>
		<td>Здесь описывается значение данного поля.</td>
	</tr>

	<tr>
		<td>[Название]</td>
		<td>Тип поля</td>
		<td>Так отмечаются необязательные поля. Классика :)</td>
	</tr>
</table>

###### Клиент - сообщение от  клиента

<table width="100%">
	<tr>
		<th>Поле</th>
		<th>Тип</th>
		<th>Описание</th>
	</tr>

	<tr>
		<td>Название</td>
		<td>Тип поля</td>
		<td>Здесь описывается значение данного поля.</td>
	</tr>

	<tr>
		<td>[Название]</td>
		<td>Тип поля</td>
		<td>Так отмечаются необязательные поля. Классика :)</td>
	</tr>
</table>

### Описание протокола
###### Версия v1.0

Итак, начнем с самого главного - подключение узлов к серверу.

#### **ПОДКЛЮЧЕНИЕ УЗЛОВ К СЕРВЕРУ**

Подключение к серверу выполняется в несколько этапов. Изначально узел пытается подключиться к слушающему сокету сервера. Сервер обрабатывает новое подключение и на основе текущей конфигурации и нескольких других факторов, таких как количество уже подключенных узлов, статус распределения блоков, принимает или отклоняет данное подключение, отвечая узлу соответствующим сообщением.

В случае отклонения подключения:

##### **SERVER / CONNECT**

<table width="100%">
	<tr>
		<th>Поле</th>
		<th>Тип</th>
		<th>Описание</th>
	</tr>

	<tr>
		<td>status</td>
		<td>String</td>
		<td>
			Информирует о статусе подключения узла:

			<ul>
				<li><b>connected</b> - успешное подключение к серверу;</li>
				<li><b>rejected</b> - подключение отклонено.</li>
			</ul>

			В данном случае <b>rejected</b>.
		</td>
	</tr>

	<tr>
		<td>reason</td>
		<td>String</td>
		<td>
			Причина отклонения подключения:

			<ul>
				<li><b>max-nodes-count</b> - превышено максимальное количество узлов;</li>
				<li><b>dsync-disabled</b> - динамическое подключение узлов запрещено.</li>
			</ul>
		</td>
	</tr>
</table>

В случае успешного подключения:

##### **SERVER / CONNECT**

<table width="100%">
	<tr>
		<th>Поле</th>
		<th>Тип</th>
		<th>Описание</th>
	</tr>

	<tr>
		<td>status</td>
		<td>String</td>
		<td>
			Информирует о статусе подключения узла:

			<ul>
				<li><b>connected</b> - успешное подключение к серверу;</li>
				<li><b>rejected</b> - подключение отклонено.</li>
			</ul>
			В данном случае <b>connected</b>.
		</td>
	</tr>

	<tr>
		<td>async_allowed</td>
		<td>Boolean</td>
		<td>
			Информирует о возможности подключения асинхронных узлов.
		</td>
	</tr>

	<tr>
		<td>secure</td>
		<td>Boolean</td>
		<td>
			Сообщает о необходимости предоставления пароля при подключении узла.
		</td>
	</tr>

	<tr>
		<td>salt</td>
		<td>Number</td>
		<td>
			Соль для защиты от перебора паролей к кластеру.
		</td>
	</tr>
</table>

На основе полученных сведений узел либо разрывает соединение, либо выполняет хэширование соли и пароля, тестирование своей производительности и отправляет новый запрос следующего содержания:

##### **CLIENT / JOIN**

<table width="100%">
	<tr>
		<th>Поле</th>
		<th>Тип</th>
		<th>Описание</th>
	</tr>

	<tr>
		<td>speed</td>
		<td>Number</td>
		<td>
			Скорость перебора паролей, полученная в результате бенчмарка. Используется сервером при распределении и расчете размеров блоков.
		</td>
	</tr>

	<tr>
		<td>async</td>
		<td>Boolean</td>
		<td>
			Тип данного узла:
			<ul>
				<li>
					<b>true</b> - асинхронный узел, выполняющий перебор паролей по своему словарю не зависимо от системы распределения блоков;
				</li>

				<li>
					<b>false</b> - синхронный узел, выполняющий перебор паролей по блокам словаря, полученным от сервера.
				</li>
			</ul>
		</td>
	</tr>

	<tr>
		<td>[dictionary]</td>
		<td>String</td>
		<td>
			Контрольная сумма (CRC32) словаря. Передается только в синхронном режиме.
		</td>
	</tr>

	<tr>
		<td>[secret]</td>
		<td>String</td>
		<td>
			MD5 хэш соли и пароля, если требует сервер.
		</td>
	</tr>
</table>

Получив данный запрос, сервер проверяет правильность пароля и, если если все в порядке, регистрирует данный узел в реестре. Ответ выглядит так:

##### **SERVER / JOIN**

<table width="100%">
	<tr>
		<th>Поле</th>
		<th>Тип</th>
		<th>Описание</th>
	</tr>

	<tr>
		<td>status</td>
		<td>String</td>
		<td>
			Информирует о статусе присоединения узла к кластеру:

			<ul>
				<li><b>joined</b> - успешное присоединение;</li>
				<li><b>rejected</b> - присоединение отклонено.</li>
			</ul>
		</td>
	</tr>

	<tr>
		<td>[reason]</td>
		<td>String</td>
		<td>
			Причина отклонения присоединения:

			<ul>
				<li><b>bad-secret</b> - неверный пароль;</li>
				<li><b>async-disallowed</b> - подключение асинхронных клиентов запрещено.</li>
			</ul>

			Только в случае <b>status = rejected</b>.
		</td>
	</tr>
</table>



MAKE GITHUB WIKI!
DESCRIBE DRIVERS DEFINITION SYNATX.
ТЕРМИНЫ.
ХЭШ СЛОВАРЯ crc32