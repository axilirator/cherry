## Описание протокола
### Введение
Способы взаимодействия узлов и сервера описывает протокол. Каждое сообщение передается в формате JSON следующего формата:

```javascript
{
	"header" : "<заголовок>",

	// Данные сообщения... //
}
```

Заголовок определяет цель обращения узла к серверу, или наоборот. За обработку сообщений протокола отвечают два файла: **include/master_protocol.js** и **include/worker_protocol.js**, в которых хранятся обработчики. Рассмотрим пример запроса узла на присоединение к серверу:

```javascript
{
	"header" : "join",

	"secret" : "8b04b6229e11c290efd5cd8190aa9261",
	"async"  : false,
	"speed"  : 98000
}
```

В данном примере кластер защищен паролем, поэтому при подключении сервер высылает узлу случайно сгенерированное число - *соль*. Узел должен выполнить хэширование полученной соли и пароля, введенного пользователем и передать полученный хэш в запросе на присоединение. Также передается тип узла: *синхронный* или *асинхронный* и скорость, полученная в результате теста производительности. Ответ сервера может быть таким:

```javascript
{
	"header" : "connect",

	"status" : "joined"
}
```

Либо таким, в случае неверного пароля:

```javascript
{
	"header" : "connect",

	"status" : "rejected",
	"reason" : "bad-secret"
}
```

Подробнее об этапах подключения и взаимодействии узлов с сервером можно прочитать в файле **basics.md**.

### Формат описания протокола

####**ЗАГОЛОВОК** - значение поля header
---

##### Сервер - сообщение от сервера

<table width="100%">
	<tr>
		<th>Поле</th>
		<th>Тип</th>
		<th>Описание</th>
	</tr>

	<tr>
		<td>Название</td>
		<td>Тип поля</td>
		<td>Здесь описывается значение данного поля.</td>
	</tr>

	<tr>
		<td>[Название]</td>
		<td>Тип поля</td>
		<td>Так отмечаются необязательные поля. Классика :)</td>
	</tr>
</table>

##### Клиент - сообщение о  клиента

<table width="100%">
	<tr>
		<th>Поле</th>
		<th>Тип</th>
		<th>Описание</th>
	</tr>

	<tr>
		<td>Название</td>
		<td>Тип поля</td>
		<td>Здесь описывается значение данного поля.</td>
	</tr>

	<tr>
		<td>[Название]</td>
		<td>Тип поля</td>
		<td>Так отмечаются необязательные поля. Классика :)</td>
	</tr>
</table>

### Описание протокола v1.0
Итак, начнем с основных сообщений - сообщений подключения.

#### **CONNECT**
---

##### Сервер

<table width="100%">
	<tr>
		<th>Поле</th>
		<th>Тип</th>
		<th>Описание</th>
	</tr>

	<tr>
		<td>status</td>
		<td>String</td>
		<td>
			Информирует о статусе подключения узла:

			<ul>
				<li><b>connected</b> - успешное подключение к серверу;</li>
				<li><b>joined</b> - успешное присоединение к кластеру;</li>
				<li><b>rejected</b> - подключение отклонено.</li>
			</ul>
		</td>
	</tr>

	<tr>
		<td>[reason]</td>
		<td>String</td>
		<td>
			Причина отклонения подключения:

			<ul>
				<li><b>max-nodes-count</b> - превышено максимальное количество узлов;</li>
				<li><b>dsync-disabled</b> - динамическое подключение узлов запрещено;</li>
				<li><b>bad-secret</b> - неверный пароль.</li>
			</ul>
		</td>
	</tr>

	<tr>
		<td>secure</td>
		<td>Boolean</td>
		<td>
			Сообщает о необходимости предоставления пароля при подключении узла.
		</td>
	</tr>

	<tr>
		<td>salt</td>
		<td>Number</td>
		<td>
			Соль для защиты от перебора паролей к кластеру.
		</td>
	</tr>
</table>